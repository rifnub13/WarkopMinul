<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WARKOP MINUL</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d97706">
    <style>
        :root { --primary: #d97706; --green: #16a34a; --red: #dc2626; --bg: #f8fafc; --text: #334155; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); }
        .header { background: linear-gradient(135deg, var(--primary), #b45309); color: white; padding: 20px 20px 30px 20px; border-radius: 0 0 25px 25px; position: sticky; top: 0; z-index: 50; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: rgba(255,255,255,0.2); padding: 12px; border-radius: 12px; text-align: center; }
        .stat-val { font-size: 1.1em; font-weight: 800; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; padding: 16px; border-radius: 16px; margin-bottom: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .search-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #cbd5e1; outline: none; margin-bottom: 15px; box-sizing: border-box; }
        .btn { border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; width: 100%; margin-bottom: 5px; }
        .btn-wa { background: #25D366; padding: 12px; margin-bottom: 15px; }
        .btn-csv { background: #0f766e; padding: 12px; margin-bottom: 5px; } 
        .btn-sell { background: var(--green); }
        .btn-restock { background: #3b82f6; }
        .btn-edit { background: #94a3b8; }
        .btn-del-trx { background: none; border: none; cursor: pointer; color: #cbd5e1; }
        .fab { position: fixed; bottom: 85px; right: 20px; background: var(--primary); width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 28px; z-index: 90; border: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid #e2e8f0; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { padding: 12px; text-align: center; color: #94a3b8; font-weight: 600; }
        .nav-item.active { color: var(--primary); background: #fffbeb; }
        .detail-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .detail-table th { text-align: left; background: #f1f5f9; padding: 8px; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .col-money { text-align: right; font-family: monospace; }
        .trx-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 200; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size:1.5em; font-weight:800; margin-bottom:10px;">‚òï WARKOP MINUL</div>
    <div class="stats-grid">
        <div class="stat-box"><div class="stat-val" id="headerOmset">Rp 0</div><div style="font-size:0.8em">Omset Hari Ini</div></div>
        <div class="stat-box"><div class="stat-val" id="headerLaci">Rp 0</div><div style="font-size:0.8em">Uang di Laci</div></div>
    </div>
</div>

<!-- KASIR -->
<div id="viewKasir" class="tab-content active container">
    <input type="text" class="search-input" id="searchInput" placeholder="üîç Cari menu..." onkeyup="renderList()">
    <div id="productList"></div>
    <div style="height:50px;"></div>
    <button class="fab" onclick="bukaModal('tambah')">+</button>
</div>

<!-- LAPORAN -->
<div id="viewLaporan" class="tab-content container">
    <label style="font-size:0.9em; color:#666;">Pilih Tanggal:</label>
    <input type="date" id="filterDate" onchange="renderLaporan()" style="width:100%; padding:12px; margin-bottom:15px;">

    <button class="btn btn-wa" onclick="shareSummaryWA()">üì≤ KIRIM RINGKASAN (WA)</button>
    <button class="btn" style="background:var(--red); padding:15px;" onclick="bukaModalPengeluaran()">üí∏ CATAT PENGELUARAN</button>

    <div class="card">
        <h3>Ringkasan</h3>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Omset</span><b style="color:var(--green)" id="lapOmset">Rp 0</b></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Keluar</span><b style="color:var(--red)" id="lapPengeluaran">Rp 0</b></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Sisa Kas</span><b style="color:var(--primary)" id="lapSisa">Rp 0</b></div>
        <div style="display:flex; justify-content:space-between;"><span>Laba</span><b id="lapLaba">Rp 0</b></div>
    </div>

    <div class="card">
        <h3>üì¶ Detail Stok</h3>
        <div style="overflow-x:auto">
            <table class="detail-table">
                <thead><tr><th>Item</th><th>Awal</th><th>Jual</th><th>Sisa</th><th>Omset</th></tr></thead>
                <tbody id="stockDetailBody"></tbody>
                <tfoot id="stockDetailFooter" style="background:#f1f5f9; font-weight:bold;"></tfoot>
            </table>
        </div>
        <button class="btn" style="border:1px solid #25D366; color:#25D366; background:white; margin-top:10px;" onclick="shareDetailStokWA()">üì≤ KIRIM DETAIL STOK (WA)</button>
    </div>

    <h3>Riwayat</h3>
    <div class="card" id="transactionList"></div>

    <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
        <h3>Pengaturan Data</h3>
        
        <!-- TOMBOL IMPORT -->
        <button class="btn btn-csv" onclick="document.getElementById('csvInput').click()">üì• Import Data Excel (.CSV)</button>
        <input type="file" id="csvInput" hidden accept=".csv" onchange="handleCSV(this)">
        <small style="display:block; color:#666; margin-bottom:15px; font-size:0.8em;">
            *Format Excel: <b>Nama, Beli, Jual, Stok</b>
        </small>

        <button class="btn" style="background:#64748b" onclick="downloadData()">üíæ Backup Data</button>
        <input type="file" id="fileInput" hidden onchange="uploadData(this)">
        <button class="btn" style="background:#94a3b8" onclick="document.getElementById('fileInput').click()">üìÇ Restore Backup</button>
        <button class="btn" style="background:#fee2e2; color:var(--red)" onclick="hapusSemuaData()">üóëÔ∏è Reset Aplikasi</button>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('kasir', this)">üè™ Kasir</div>
    <div class="nav-item" onclick="switchTab('laporan', this)">üìä Laporan</div>
</div>

<!-- MODALS -->
<div class="modal" id="modalForm"><div class="modal-content"><h3>Menu</h3><input type="hidden" id="itemId"><input type="text" id="nama" placeholder="Nama"><input type="number" id="hargaBeli" placeholder="Modal"><input type="number" id="hargaJual" placeholder="Jual"><input type="number" id="stok" placeholder="Stok"><button class="btn" style="background:var(--primary)" onclick="simpanBarang()">Simpan</button><button class="btn" style="background:#ccc;color:#333" onclick="tutupModal('modalForm')">Batal</button></div></div>
<div class="modal" id="modalJual"><div class="modal-content"><h3>Jual</h3><p id="jualNama"></p><input type="hidden" id="jualId"><input type="number" id="jualQty" value="1" style="text-align:center;font-size:1.5em"><button class="btn btn-sell" onclick="prosesJual()">KONFIRMASI</button><button class="btn" style="background:#ccc;color:#333" onclick="tutupModal('modalJual')">Batal</button></div></div>
<div class="modal" id="modalRestock"><div class="modal-content"><h3>Stok</h3><input type="hidden" id="restockId"><input type="number" id="restockQty" placeholder="Jml Masuk" style="text-align:center;font-size:1.5em"><button class="btn btn-restock" onclick="prosesRestock()">TAMBAH</button><button class="btn" style="background:#ccc;color:#333" onclick="tutupModal('modalRestock')">Batal</button></div></div>
<div class="modal" id="modalPengeluaran"><div class="modal-content"><h3>Keluar</h3><input type="text" id="ketPengeluaran" placeholder="Ket"><input type="number" id="jmlPengeluaran" placeholder="Rp"><button class="btn" style="background:var(--red)" onclick="simpanPengeluaran()">SIMPAN</button><button class="btn" style="background:#ccc;color:#333" onclick="tutupModal('modalPengeluaran')">Batal</button></div></div>

<!-- SCRIPT (LOGIKA PROGRAM ADA DISINI) -->
<script>
    let products=JSON.parse(localStorage.getItem('warkop_products'))||[];
    let transactions=JSON.parse(localStorage.getItem('warkop_transactions'))||[];
    let expenses=JSON.parse(localStorage.getItem('warkop_expenses'))||[];
    document.getElementById('filterDate').valueAsDate=new Date();

    function save(){localStorage.setItem('warkop_products',JSON.stringify(products));localStorage.setItem('warkop_transactions',JSON.stringify(transactions));localStorage.setItem('warkop_expenses',JSON.stringify(expenses));renderList();renderStats();}
    function fmt(n){return "Rp "+parseInt(n).toLocaleString('id-ID');}
    function fmtK(n){return (n/1000).toFixed(0)+'k';}
    function switchTab(t,el){document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));document.getElementById(t==='kasir'?'viewKasir':'viewLaporan').classList.add('active');document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));el.classList.add('active');if(t==='laporan')renderLaporan();}
    function tutupModal(id){document.getElementById(id).style.display='none';}

    // --- FUNGSI IMPORT CSV YANG DIPERBAIKI ---
    function handleCSV(input) {
        let file = input.files[0];
        if (!file) return;
        if (!file.name.toLowerCase().endsWith('.csv')) { alert("Pilih file .csv!"); return; }

        let reader = new FileReader();
        reader.readAsText(file);
        reader.onload = function() {
            try {
                let csv = reader.result;
                let lines = csv.split(/\r\n|\n/);
                let count = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    let line = lines[i].trim();
                    if (line) {
                        let separator = line.includes(';') ? ';' : ','; // Deteksi otomatis
                        let cols = line.split(separator);

                        if (cols.length >= 4) {
                            let nama = cols[0].replace(/"/g, "").trim();
                            // Fungsi pembersih angka (hapus Rp, titik, spasi)
                            let cleanNum = (str) => {
                                if (!str) return 0;
                                let numb = str.toString().replace(/[^0-9]/g, ''); 
                                return parseInt(numb) || 0;
                            };

                            let beli = cleanNum(cols[1]);
                            let jual = cleanNum(cols[2]);
                            let stok = cleanNum(cols[3]);

                            if (nama && jual > 0) {
                                products.push({id: Date.now() + i, nama, beli, jual, stok});
                                count++;
                            }
                        }
                    }
                }
                
                if (count > 0) { save(); alert("Berhasil import " + count + " data!"); location.reload(); }
                else { alert("Gagal. Cek format Excel anda."); }
            } catch (e) { alert("Error: " + e.message); }
        };
    }

    function renderStats(){
        let today=new Date().toLocaleDateString('id-ID');
        let omset=transactions.filter(t=>t.date===today).reduce((a,b)=>a+b.total,0);
        let out=expenses.filter(e=>e.date===today).reduce((a,b)=>a+b.amount,0);
        document.getElementById('headerOmset').innerText=fmt(omset); document.getElementById('headerLaci').innerText=fmt(omset-out);
    }
    function renderList(){
        let key=document.getElementById('searchInput').value.toLowerCase();
        let list=document.getElementById('productList');list.innerHTML='';
        products.filter(p=>p.nama.toLowerCase().includes(key)).sort((a,b)=>a.stok-b.stok).forEach(p=>{
            list.innerHTML+=`<div class="card" style="display:flex;justify-content:space-between;align-items:center;">
                <div><b>${p.nama}</b><br><span style="color:#666;font-size:0.9em">${fmt(p.jual)}</span></div>
                <div style="text-align:right"><span style="background:${p.stok<=5?'#fee2e2':'#f1f5f9'};padding:2px 8px;border-radius:10px;font-size:0.8em">üì¶ ${p.stok}</span><br>
                <button class="btn btn-sell" style="width:auto;padding:5px 10px;margin-top:5px;font-size:0.8em" onclick="modalJual(${p.id})">JUAL</button>
                <button class="btn" style="width:auto;padding:5px 10px;margin-top:5px;font-size:0.8em;background:#94a3b8" onclick="modalEdit(${p.id})">‚öôÔ∏è</button></div>
            </div>`;
        });
        renderStats();
    }
    function renderLaporan(){
        let dateStr=new Date(document.getElementById('filterDate').value).toLocaleDateString('id-ID');
        let omset=0,profit=0,out=0; let trx=transactions.filter(t=>t.date===dateStr); let exp=expenses.filter(e=>e.date===dateStr);
        trx.forEach(t=>{omset+=t.total;profit+=t.profit;}); exp.forEach(e=>{out+=e.amount;});
        
        let tb=document.getElementById('stockDetailBody'); tb.innerHTML='';
        let tf=document.getElementById('stockDetailFooter');
        let totOmsetTable=0;

        products.forEach(p=>{
            let sold=trx.filter(t=>t.itemId===p.id).reduce((a,b)=>a+b.qty,0);
            let awal=p.stok+sold;
            if(awal>0||sold>0) {
                let omsetItem = sold*p.jual;
                totOmsetTable += omsetItem;
                tb.innerHTML+=`<tr><td>${p.nama}</td><td>${awal}</td><td style="color:var(--red)">${sold}</td><td style="color:var(--primary)">${p.stok}</td><td class="col-money">${fmtK(omsetItem)}</td></tr>`;
            }
        });
        
        tf.innerHTML=`<tr><td colspan="4" style="text-align:right">TOTAL:</td><td class="col-money">${fmtK(totOmsetTable)}</td></tr>`;

        document.getElementById('lapOmset').innerText=fmt(omset);document.getElementById('lapPengeluaran').innerText=fmt(out);
        document.getElementById('lapSisa').innerText=fmt(omset-out);document.getElementById('lapLaba').innerText=fmt(profit);
        
        let hList=document.getElementById('transactionList'); hList.innerHTML='';
        let hist=[...trx.map(t=>({...t,type:'in'})), ...exp.map(e=>({...e,type:'out'}))].sort((a,b)=>b.time.localeCompare(a.time));
        if(hist.length===0) hList.innerHTML='<div style="text-align:center;padding:20px;color:#ccc">Kosong</div>';
        hist.forEach(h=>{
            if(h.type==='in') hList.innerHTML+=`<div class="trx-item"><div><b>${h.nama}</b> x${h.qty}<br><span style="color:#999">${h.time}</span></div><div style="text-align:right"><b>+${fmt(h.total)}</b></div></div>`;
            else hList.innerHTML+=`<div class="trx-item" style="background:#fff5f5"><div><b style="color:var(--red)">${h.desc}</b><br><span style="color:#999">${h.time}</span></div><div style="text-align:right"><b style="color:var(--red)">-${fmt(h.amount)}</b></div></div>`;
        });
    }
    
    // Actions
    function bukaModal(m){if(m==='tambah'){document.getElementById('itemId').value='';document.getElementById('nama').value='';document.getElementById('hargaBeli').value='';document.getElementById('hargaJual').value='';document.getElementById('stok').value='';}document.getElementById('modalForm').style.display='flex';}
    function bukaModalPengeluaran(){document.getElementById('ketPengeluaran').value='';document.getElementById('jmlPengeluaran').value='';document.getElementById('modalPengeluaran').style.display='flex';}
    function modalEdit(id){let p=products.find(x=>x.id==id);document.getElementById('itemId').value=p.id;document.getElementById('nama').value=p.nama;document.getElementById('hargaBeli').value=p.beli;document.getElementById('hargaJual').value=p.jual;document.getElementById('stok').value=p.stok;document.getElementById('modalForm').style.display='flex';}
    function modalJual(id){let p=products.find(x=>x.id==id);if(p.stok<=0)return alert('Habis');document.getElementById('jualId').value=id;document.getElementById('jualNama').innerText=p.nama;document.getElementById('jualQty').value=1;document.getElementById('modalJual').style.display='flex';}
    
    function simpanBarang(){
        let id=document.getElementById('itemId').value, nama=document.getElementById('nama').value;
        let beli=parseInt(document.getElementById('hargaBeli').value)||0, jual=parseInt(document.getElementById('hargaJual').value)||0;
        let stok=parseInt(document.getElementById('stok').value)||0;
        if(!nama)return alert('Nama wajib');
        if(id){let i=products.findIndex(x=>x.id==id);products[i]={id:parseInt(id),nama,beli,jual,stok};}
        else{products.push({id:Date.now(),nama,beli,jual,stok});}
        save();tutupModal('modalForm');
    }
    function prosesJual(){
        let id=parseInt(document.getElementById('jualId').value), qty=parseInt(document.getElementById('jualQty').value);
        let i=products.findIndex(x=>x.id==id), p=products[i];
        if(qty>p.stok)return alert('Stok kurang');
        products[i].stok-=qty;
        let now=new Date();
        transactions.push({date:now.toLocaleDateString('id-ID'),time:now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}),itemId:id,nama:p.nama,qty,total:p.jual*qty,profit:(p.jual-p.beli)*qty});
        save();tutupModal('modalJual');
    }
    function prosesRestock(){
        let id=parseInt(document.getElementById('restockId').value), qty=parseInt(document.getElementById('restockQty').value);
        if(qty>0) { products.find(x=>x.id==id).stok+=qty; save(); tutupModal('modalRestock'); }
    }
    function simpanPengeluaran(){
        let desc=document.getElementById('ketPengeluaran').value, amount=parseInt(document.getElementById('jmlPengeluaran').value);
        if(desc&&amount>0){expenses.push({date:new Date().toLocaleDateString('id-ID'),time:new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}),desc,amount});save();tutupModal('modalPengeluaran');renderLaporan();}
    }
    
    function shareSummaryWA(){
        let d=document.getElementById('filterDate').value, o=document.getElementById('lapOmset').innerText, k=document.getElementById('lapPengeluaran').innerText, s=document.getElementById('lapSisa').innerText, l=document.getElementById('lapLaba').innerText;
        window.open(`https://wa.me/?text=${encodeURIComponent(`*WARKOP MINUL*\nüìÖ ${d}\nüí∞ Omset: ${o}\nüí∏ Keluar: ${k}\nüíµ Sisa: ${s}\nüìà Laba: ${l}`)}`,'_blank');
    }
    function shareDetailStokWA(){
        let d=document.getElementById('filterDate').value, trx=transactions.filter(t=>t.date===new Date(d).toLocaleDateString('id-ID'));
        let txt=`*STOK ${d}*\n`;
        let grandTotOmset=0, grandTotLaba=0;
        let hasItem=false;
        products.forEach(p=>{
            let sold=trx.filter(t=>t.itemId===p.id).reduce((a,b)=>a+b.qty,0);
            let omsetItem = sold*p.jual;
            let labaItem = sold*(p.jual-p.beli);
            if(p.stok+sold>0||sold>0) {
                hasItem=true;
                grandTotOmset+=omsetItem; grandTotLaba+=labaItem;
                txt+=`${p.nama}\nAwal:${p.stok+sold} Jual:${sold} Sisa:${p.stok}\nüí∞ ${fmt(omsetItem)} üìà ${fmt(labaItem)}\n\n`;
            }
        });
        if(!hasItem) txt+="Tidak ada transaksi.\n";
        txt+=`\n*TOTAL HARI INI:*\nüí∞ OMSET: ${fmt(grandTotOmset)}\nüìà LABA: ${fmt(grandTotLaba)}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`,'_blank');
    }
    
    function downloadData(){let a=document.createElement('a');a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify({products,transactions,expenses}));a.download='BACKUP.json';document.body.appendChild(a);a.click();a.remove();}
    function uploadData(el){let r=new FileReader();r.onload=function(){let d=JSON.parse(r.result);products=d.products;transactions=d.transactions||[];expenses=d.expenses||[];save();alert('OK');location.reload();};r.readAsText(el.files[0]);}
    function hapusSemuaData(){if(prompt('Ketik HAPUS')==='HAPUS'){localStorage.clear();location.reload();}}
    
    renderList();
</script>
</body>
</html>
